version: '3.8'

# volumes:
#   brachiograph_ws:

networks:
  x11: 
  # ros_network:
  #   driver: bridge
  #   ipam:
  #     config:
  #       - subnet: 172.28.0.0/16
          # gateway: 172.28.0.1

services:
  ros-noetic-and-gazebo:
    build: ./
    image: hybrayhem/brachiograph-sim
    container_name: brachiograph-sim
    # volumes:
    #   - ./docker-volumes/brachiograph_ws:/root/brachiograph_ws # No data generated by project for now
    ports:
      - "3800:3800" # host:container
    networks:
      x11:
      # ros_network:
      #   ipv4_address: 172.28.5.5
    environment:
      - DISPLAY=novnc:0.0
    tty: true
    stdin_open: true
    # restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rosnode list | grep gazebo"]
      interval: 5s
      timeout: 10s
      retries: 10
  
  novnc:
    image: theasp/novnc:latest
    container_name: brachiograph-novnc
    ports:
      - "5900:8080" # host:container
    networks:
      - x11
    environment:
      - DISPLAY_WIDTH=960
      - DISPLAY_HEIGHT=540
      - RUN_XTERM=no
      - RUN_FLUXBOX=no
    # restart: on-failure
    # command: ["rm -rf /tmp/{*,.*}", "/app/entrypoint.sh"] # # novnc sometimes fails on x11, fixed with this
    depends_on:
      ros-noetic-and-gazebo:
        condition: service_healthy